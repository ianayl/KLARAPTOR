#!/bin/bash

usage () {
    >&2 echo "Usage: $0 [options]

  -h, --help     Prints this help message
  -p             Adds KLARAPTOR to path via .profile
  -z             Adds KLARAPTOR to path via .zshrc
  no arguments:  Adds KLARAPTOR to path via .bashrc

Note: The KLARAPTOR config is created in \$PWD!
      The parent of \$PWD is also treated as KLARAPTOR's root directory!"
    exit
}

# Filename constants
KLARAPTOR_CONFIG_FILENAME="klaraptor_path.conf"
BASHRC_PATH="$HOME/.bashrc"
PROFILE_PATH="$HOME/.profile"
ZSHRC_PATH="$HOME/.zshrc"

klaraptor_root="$(dirname $PWD)"
klaraptor_config_path="$PWD/$KLARAPTOR_CONFIG_FILENAME"

# Creates a KLARAPTOR config if it doesn't already exist
ensure_config_exists() {
    if [ -e "$klaraptor_config_path" ]
    then
        echo "[KLARAPTOR configuration already exists at $klaraptor_config_path: skipping new configuration] ..."
        return 1
    fi
    # Construct a new klaraptor config
    echo "[Generating new KLARAPTOR configuration at $klaraptor_config_path] ..."
    printf "export KLARAPTOR_PATH=$klaraptor_root\n" > $klaraptor_config_path
    printf "export PATH=\$PATH:\$KLARAPTOR_PATH/bin/" >> $klaraptor_config_path
}

# Source the KLARAPTOR config in file $1
add_klaraptor_path() {
    printf "[Adding KLARAPTOR_PATH to $1] ... \n"

    source_line=". $klaraptor_config_path"
    if grep -Fxq "$source_line" $1 
    then
            # printf "Path is already set! \n"
            printf ""
    else
        printf "\n\n" >> $1
        printf "######################################\n" >> $1
        printf "######################################\n" >> $1 
        printf "#### ADDING KLARAPTOR_PATH [""$(date)""]\n" >> $1
        printf "###################################### \n" >> $1

        printf "if [ -e $klaraptor_config_path ]; then \n" >> $1
    #	printf "    source $dest \n" >> $target
        printf "    $source_line\n" >> $1
        printf "fi;\n">> $1

        printf "######################################\n" >> $1
        printf "######################################\n" >> $1
    fi

    printf "[Installation of KLARAPTOR is done] ...\n"
}


case $1 in
    -p) ensure_config_exists; add_klaraptor_path "$PROFILE_PATH" ;;
    -z) ensure_config_exists; add_klaraptor_path "$ZSHRC_PATH" ;;
    "") ensure_config_exists; add_klaraptor_path "$BASHRC_PATH" ;;
    *) usage ;;
esac
